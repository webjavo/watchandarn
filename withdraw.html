<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Withdraw — Watch & Earn</title>
<style>
:root{
  --bg:#e8f2ff;
  --card:#ffffff;
  --accent:#1e6fdb;
  --accent-2:#0b57b5;
  --muted:#48607f;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#14303b}
.container{max-width:420px;margin:0 auto;padding:14px}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(2,6,23,0.08);margin-top:14px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(20,48,59,0.06);color:var(--accent-2);padding:8px 12px;border-radius:10px;cursor:pointer}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(11,87,181,0.08);margin-top:8px;font-size:14px}
.muted{color:var(--muted);font-size:14px}
.note{font-size:13px;color:var(--muted);margin-top:10px}
</style>
</head>
<body>
<div class="container">
  <h2 style="color:var(--accent-2)">Withdraw</h2>
  <div class="card">
    <div class="muted">Available Balance: ₦<span id="avail">0</span></div>
    <input class="input" id="amount" placeholder="Enter amount (₦5000 - ₦10000)"/>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="sendBtn">Send</button>
      <button class="btn-ghost" id="cancelBtn">Cancel</button>
    </div>
    <div class="note">Minimum ₦5000 — Maximum ₦10000 per request. You’ll receive a WhatsApp message automatically.</div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { 
  getFirestore, collection, addDoc, doc, getDoc, updateDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// --- FIREBASE INIT ---
const firebaseConfig = {
  apiKey: "AIzaSyCzFqbBdIMucN6A7zE6US6aZziyp_3lMB0",
  authDomain: "watchandarn.firebaseapp.com",
  projectId: "watchandarn",
  storageBucket: "watchandarn.appspot.com",
  messagingSenderId: "670181055241",
  appId: "1:670181055241:web:974eabbaff1c2cbf28d1d8",
  measurementId: "G-P1QGG9WV4R"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const qs = id => document.getElementById(id);
let user = null;
let userDocRef = null;
let userData = null;

// --- AUTH STATE ---
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  user = u;
  userDocRef = doc(db, 'users', user.uid);
  
  // listen live for balance updates
  onSnapshot(userDocRef, snap=>{
    if(snap.exists()){
      userData = snap.data();
      qs('avail').innerText = (userData.balance || 0).toFixed(0);
    }
  });
});

// --- CANCEL BUTTON ---
qs('cancelBtn').addEventListener('click', ()=> location.href='dashboard.html');

// --- SEND BUTTON ---
qs('sendBtn').addEventListener('click', async ()=>{
  const btn = qs('sendBtn');
  btn.disabled = true;
  const amt = Number(qs('amount').value.trim());
  if(isNaN(amt) || amt < 5000){ return toast('Minimum ₦5000'); }
  if(amt > 10000){ return toast('Maximum ₦10000'); }
  if(!userData || (userData.balance || 0) < amt){ return toast('Insufficient balance'); }

  const code = 'WE-' + Math.random().toString(36).substring(2,6).toUpperCase();

  try{
    // deduct user balance
    await updateDoc(userDocRef, { balance: (userData.balance || 0) - amt });

    // create withdrawal record
    await addDoc(collection(db, 'withdrawals'), {
      userEmail: user.email,
      username: userData?.username || '-',
      amount: amt,
      code,
      time: Date.now()
    });

    // WhatsApp alert
    const msg = encodeURIComponent(`Hi Admin, I withdrew ₦${amt} using code: ${code}`);
    window.open(`https://wa.me/2347031935351?text=${msg}`, '_blank');

    toast('Withdrawal successful!');
    qs('amount').value = '';
  }catch(e){
    console.error(e);
    toast('Withdrawal failed, try again');
  }finally{
    btn.disabled = false;
  }
});

// --- Toast Message ---
function toast(msg){
  const el = document.createElement('div');
  el.style.position='fixed';
  el.style.left='50%';
  el.style.top='18%';
  el.style.transform='translateX(-50%)';
  el.style.background='white';
  el.style.padding='10px 16px';
  el.style.borderRadius='10px';
  el.style.boxShadow='0 10px 30px rgba(0,0,0,0.1)';
  el.style.zIndex='9999';
  el.innerText=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),2200);
}
</script>
</body>
</html>
0);
}
</script>
